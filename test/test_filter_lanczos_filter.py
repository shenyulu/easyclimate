"""
pytest for filter/lanczos_filter.py
"""

import pytest

import easyclimate as ecl
import numpy as np
import xarray as xr
import pandas as pd
from pathlib import Path
from .const_define import TEST_DATA_PATH

data_lanczos = xr.DataArray(
    data=np.array(
        [
            -1.22520196e-05,
            -5.61636034e-06,
            -1.10928795e-05,
            -1.59478295e-05,
            -1.42007202e-05,
            6.71420685e-06,
            3.94234894e-06,
            -3.95324605e-06,
            -1.82997101e-05,
            -4.74280523e-06,
            -2.01812127e-05,
            -1.65693982e-05,
            1.29130885e-05,
            -1.65190013e-05,
            -2.12731575e-05,
            -1.11096788e-05,
            -8.11807070e-07,
            -8.77459843e-06,
            1.86079960e-05,
            -1.45031045e-05,
            -5.06198876e-06,
            2.07246885e-05,
            -1.04881101e-05,
            3.80931738e-07,
            -2.69848642e-05,
            -3.61235943e-05,
            -1.24368107e-05,
            -1.39487329e-05,
            -1.12272728e-05,
            7.25177915e-06,
            -1.43519119e-05,
            -1.73421595e-05,
            -1.54438567e-05,
            -7.80024857e-06,
            -2.15587424e-05,
            -1.79973249e-05,
            -2.47169810e-05,
            -2.16931348e-05,
            -7.74985074e-06,
            -1.53417000e-06,
            -1.91060681e-05,
            -1.63006116e-05,
            -1.46542970e-05,
            1.32658706e-05,
            -9.16097815e-06,
            2.93440075e-06,
            -3.58366492e-06,
            5.26948088e-06,
            1.47287574e-06,
            7.36937318e-06,
            -1.38143396e-05,
            -2.32890543e-05,
            -6.17073192e-06,
            -9.29401040e-07,
            -1.34279599e-05,
            2.05734959e-05,
            -6.33872332e-06,
            -8.52261110e-06,
            -1.48054887e-05,
            -4.00364343e-06,
            -3.16368642e-06,
            2.96936037e-07,
            -1.01353289e-05,
            -4.60841238e-06,
            5.99184386e-06,
            1.03428201e-05,
            8.74690249e-06,
            9.75485091e-06,
            -7.41386839e-06,
            4.32872912e-06,
            -7.51466314e-06,
            6.51261689e-06,
            -6.96029156e-06,
            -1.33258038e-06,
            -3.64091793e-05,
            -3.93658302e-05,
            -7.27947508e-06,
            6.31102739e-06,
            -9.96733706e-06,
            -1.22856181e-05,
            -1.53430610e-05,
            2.12940364e-07,
            -5.09558731e-06,
            -2.79410528e-06,
            -4.75824294e-07,
            1.65766619e-06,
            7.52056530e-06,
            2.91760148e-06,
            -3.02929334e-06,
            -8.23702612e-06,
            -6.72510350e-06,
            -7.17868033e-06,
            -2.77730624e-06,
            -2.97889574e-06,
            1.81208216e-05,
            1.25771057e-05,
            -6.08673645e-06,
            -2.65971221e-06,
            -7.09468486e-06,
            -9.37936784e-06,
            -8.42181635e-06,
            -1.80477218e-05,
            -1.08408922e-05,
            2.32277598e-05,
            1.48281906e-05,
            1.22243237e-05,
            3.34920333e-05,
            2.74779413e-05,
            -4.33962623e-06,
            6.00864314e-06,
            1.88767826e-05,
            1.12499738e-05,
            2.29085763e-05,
            1.35682549e-05,
            -5.29717681e-06,
            8.76370177e-06,
            3.68686597e-05,
            1.68104889e-05,
            6.39502332e-06,
            -9.29537146e-06,
            -4.55801501e-06,
            2.08086840e-05,
            -2.39092606e-06,
            -1.12272728e-05,
            -8.47221418e-06,
            1.43410152e-05,
            6.89899707e-06,
            -1.27895928e-05,
            6.44542069e-06,
            -2.31042632e-05,
            -1.13112683e-05,
            -2.83287955e-05,
            -1.53430610e-05,
            -2.02652081e-05,
            -3.90466448e-05,
            8.74690249e-06,
            -1.28567890e-05,
            -3.66611675e-05,
            7.83974883e-06,
            -4.72600641e-06,
            2.01044804e-06,
            3.95914822e-06,
            -1.13952638e-05,
            -1.23178552e-06,
            -1.14288623e-05,
            1.28808517e-06,
            1.01244314e-05,
            -2.46161853e-05,
            -3.68291585e-05,
            -2.85807819e-05,
            2.46402487e-06,
            7.06698847e-06,
            -5.26357871e-06,
            8.15893236e-06,
            1.04268165e-05,
            -7.53146242e-06,
            -1.14778982e-06,
            -7.44746649e-06,
            -3.85245085e-06,
            5.43747228e-06,
            -1.42175195e-05,
            -2.76064329e-05,
            -6.32192450e-06,
            1.10700872e-04,
            -1.04545124e-05,
            1.62406798e-06,
            3.08559288e-06,
            4.05994297e-06,
            -1.24032122e-05,
            -2.78248208e-05,
            3.16958858e-06,
            -6.60750948e-06,
            -7.59865861e-06,
            -1.73085609e-05,
            -6.67470613e-06,
            2.34643085e-06,
            -6.94349228e-06,
            -6.55711210e-06,
            -4.81000188e-06,
            -6.57391138e-06,
            -1.80295615e-06,
            -1.31578122e-06,
            3.77435754e-06,
        ]
    ),
    dims="time",
    coords={"time": pd.date_range("2016-06-01", freq="D", periods=183)},
)


def test_calc_lanczos_lowpass():
    result_data1 = (
        ecl.filter.calc_lanczos_lowpass(data_lanczos, 20, 3, method="rolling")
        .isel(time=slice(50, 55))
        .data
    )
    result_data2 = (
        ecl.filter.calc_lanczos_lowpass(data_lanczos, 20, 3, method="convolve")
        .isel(time=slice(50, 55))
        .data
    )
    refer_data = np.array(
        [
            -1.43267264e-05,
            -2.05010938e-05,
            -7.22385184e-06,
            -5.29967042e-06,
            -3.43212725e-06,
        ]
    )

    assert np.isclose(result_data1, refer_data, atol=0.01).all()
    assert np.isclose(result_data2, refer_data, atol=0.01).all()


def test_calc_lanczos_bandpass():
    result_data1 = (
        ecl.filter.calc_lanczos_bandpass(data_lanczos, 20, [3, 10], method="rolling")
        .isel(time=slice(50, 55))
        .data
    )
    result_data2 = (
        ecl.filter.calc_lanczos_bandpass(data_lanczos, 20, [3, 10], method="convolve")
        .isel(time=slice(50, 55))
        .data
    )
    refer_data = np.array(
        [
            8.21783158e-06,
            1.33842534e-05,
            3.07898814e-07,
            -5.61406041e-07,
            -1.11504102e-06,
        ]
    )

    assert np.isclose(result_data1, refer_data, atol=0.01).all()
    assert np.isclose(result_data2, refer_data, atol=0.01).all()


def test_calc_lanczos_highpass():
    result_data1 = (
        ecl.filter.calc_lanczos_highpass(data_lanczos, 20, 10, method="rolling")
        .isel(time=slice(50, 55))
        .data
    )
    result_data2 = (
        ecl.filter.calc_lanczos_highpass(data_lanczos, 20, 10, method="convolve")
        .isel(time=slice(50, 55))
        .data
    )
    refer_data = np.array(
        [
            -7.70544478e-06,
            -1.61722139e-05,
            7.45221104e-07,
            4.93167542e-06,
            -8.88079159e-06,
        ]
    )

    assert np.isclose(result_data1, refer_data, atol=0.01).all()
    assert np.isclose(result_data2, refer_data, atol=0.01).all()
